<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>MaestroBot</title>

<style>
* {
  box-sizing: border-box;
  font-family: Arial, sans-serif;
}

body {
  margin: 0;
  padding: 0;
  background: #f1f5f9;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

/* HEADER */
header {
  background: #1e293b;
  color: white;
  padding: 10px;
  text-align: center;
}

/* CHAT */
#chat {
  flex: 1;
  padding: 10px;
  overflow-y: auto;
  background: #e5e7eb;
}

/* MENSAJES */
.mensaje {
  margin-bottom: 10px;
  max-width: 85%;
  padding: 8px 10px;
  border-radius: 8px;
  font-size: 14px;
  white-space: pre-wrap;
}

.docente {
  background: #2563eb;
  color: white;
  margin-left: auto;
}

.bot {
  background: white;
  border: 1px solid #cbd5e1;
}

/* BOTONES */
.botones {
  display: flex;
  gap: 10px;
  margin: 10px 0;
  flex-wrap: wrap;
}

.botones button {
  flex: 1;
  background: #0f172a;
}

/* INPUT */
#entrada {
  display: flex;
  border-top: 1px solid #cbd5e1;
}

#texto {
  flex: 1;
  padding: 10px;
  border: none;
  outline: none;
}

button {
  padding: 10px 15px;
  border: none;
  background: #1e293b;
  color: white;
  cursor: pointer;
}

button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

/* PROGRESO */
.progress-box {
  margin: 10px 0;
  background: #fff;
  border: 1px solid #cbd5e1;
  border-radius: 8px;
  padding: 10px;
}

.progress-bar {
  width: 100%;
  height: 18px;
  background: #e5e7eb;
  border-radius: 10px;
  overflow: hidden;
  margin-top: 6px;
}

.progress-fill {
  height: 100%;
  width: 0%;
  background: #2563eb;
  transition: width 0.3s ease;
}

.progress-text {
  font-size: 13px;
}
</style>
</head>

<body>

<header>
  ðŸ¤– MaestroBot Â· Secundaria
</header>

<div id="chat"></div>

<div id="entrada">
  <input id="texto" placeholder="Escribe tu consulta docente..." />
  <button id="btnEnviar">Enviar</button>
</div>

<script>
const chat = document.getElementById("chat");
const input = document.getElementById("texto");
const boton = document.getElementById("btnEnviar");

let esperandoActivo = false;
let sistemaListo = false;

let progressFill = null;
let progressText = null;

function agregarMensaje(texto, clase="bot") {
  const div = document.createElement("div");
  div.className = `mensaje ${clase}`;
  div.innerText = texto;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

function crearProgreso() {
  const box = document.createElement("div");
  box.className = "progress-box";

  progressText = document.createElement("div");
  progressText.className = "progress-text";
  progressText.innerText = "Iniciando...";

  const bar = document.createElement("div");
  bar.className = "progress-bar";

  progressFill = document.createElement("div");
  progressFill.className = "progress-fill";

  bar.appendChild(progressFill);
  box.appendChild(progressText);
  box.appendChild(bar);

  chat.appendChild(box);
  chat.scrollTop = chat.scrollHeight;
}

function setProgreso(p) {
  if (progressFill) {
    progressFill.style.width = p + "%";
  }
}

function setTextoProgreso(t) {
  if (progressText) {
    progressText.innerText = t;
  }
}

function agregarOpcionesInstalacion(ram, recomendada) {
  agregarMensaje(`ðŸ–¥ï¸ Tu computadora tiene aproximadamente ${ram} GB de RAM.`);
  agregarMensaje(`ðŸ¤– RecomendaciÃ³n: ${recomendada === "8gb" ? "versiÃ³n avanzada (8 GB)" : "versiÃ³n ligera (4 GB)"}.`);

  const cont = document.createElement("div");
  cont.className = "botones";

  const bAuto = document.createElement("button");
  bAuto.innerText = "âœ¨ Usar versiÃ³n recomendada";
  bAuto.onclick = () => preparar(recomendada);

  const b4 = document.createElement("button");
  b4.innerText = "ðŸ–¥ï¸ VersiÃ³n 4 GB";
  b4.onclick = () => preparar("4gb");

  const b8 = document.createElement("button");
  b8.innerText = "ðŸ’» VersiÃ³n 8 GB";
  b8.onclick = () => preparar("8gb");

  const bInfo = document.createElement("button");
  bInfo.innerText = "â„¹ï¸ Â¿CÃ³mo ver mi RAM?";
  bInfo.onclick = () => {
    agregarMensaje(
`ðŸ“˜ Puedes ver la memoria RAM asÃ­:
- Ctrl + Shift + Esc â†’ Rendimiento â†’ Memoria
- O clic derecho en "Este equipo" â†’ Propiedades`
    );
  };

  cont.appendChild(bAuto);
  cont.appendChild(b4);
  cont.appendChild(b8);
  cont.appendChild(bInfo);

  chat.appendChild(cont);
  chat.scrollTop = chat.scrollHeight;
}

async function preparar(version) {
  boton.disabled = true;
  input.disabled = true;

  agregarMensaje("â³ Preparando entorno de MaestroBot...");
  crearProgreso();
  setProgreso(1);

  try {
    await window.electronAPI.prepareEntorno(version);
    setProgreso(100);
    setTextoProgreso("Completado");
    agregarMensaje("âœ… MaestroBot IA estÃ¡ listo. Ya puedes usarlo.");
    sistemaListo = true;
  } catch (e) {
    agregarMensaje("âŒ Error preparando el entorno.");
  }

  boton.disabled = false;
  input.disabled = false;
}

async function verificarEstado() {
  const estado = await window.electronAPI.checkIAStatus();

  if (estado.status === "ready") {
    sistemaListo = true;
    agregarMensaje("ðŸ‘‹ MaestroBot listo. Â¿En quÃ© te ayudo?");
    return;
  }

  agregarMensaje("âš™ï¸ Es la primera vez que usas MaestroBot IA.");
  agregarMensaje("Vamos a preparar el entorno automÃ¡ticamente.");

  const info = await window.electronAPI.getRamInfo();
  agregarOpcionesInstalacion(info.ram, info.recommended);
}

// Eventos desde Electron
window.electronAPI.onIAStep((t) => {
  setTextoProgreso(t);
});

window.electronAPI.onIAProgressPercent((p) => {
  setProgreso(p);
});

window.electronAPI.onIAProgress((txt) => {
  if (progressText) {
    progressText.innerText = txt.toString().slice(0, 120);
  }
});

async function enviar() {
  if (esperandoActivo || !sistemaListo) return;

  const texto = input.value.trim();
  if (!texto) return;

  esperandoActivo = true;
  boton.disabled = true;

  agregarMensaje(texto, "docente");
  input.value = "";

  const esperando = document.createElement("div");
  esperando.className = "mensaje bot";
  esperando.innerText = "MaestroBot estÃ¡ pensando...";
  chat.appendChild(esperando);
  chat.scrollTop = chat.scrollHeight;

  try {
    const respuesta = await window.MaestroBot.responder(texto);
    esperando.innerText = respuesta || "âš ï¸ MaestroBot no devolviÃ³ respuesta.";
  } catch (e) {
    esperando.innerText = "âŒ Error interno.";
  }

  esperandoActivo = false;
  boton.disabled = false;
}

// Enviar con botÃ³n
boton.addEventListener("click", enviar);

// Enter
input.addEventListener("keydown", (e) => {
  if (e.key === "Enter") enviar();
});

// Inicio
verificarEstado();
</script>

</body>
</html>
